<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ISTOS Task Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <img src="istos-logo.png" alt="ISTOS Logo" class="logo" />
    <h2>My Assigned Tasks</h2>

    <div class="form-grid">
      <div class="form-row">
        <label for="employee">Team Member</label>
        <select id="employee">
          <option value="" disabled selected>Choose team member</option>
          <option value="Pooja">Pooja</option>
          <option value="Chaitra">Chaitra</option>
          <option value="Mazhar">Mazhar</option>
          <option value="Praveen">Praveen</option>
          <option value="Sarfaraz">Sarfaraz</option>
          <option value="Sridhar">Sridhar</option>
        </select>
      </div>
    </div>

    <table id="taskTable">
      <thead>
        <tr>
          <th>Description</th>
          <th>Priority</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="toast" class="toast" style="display: none;"></div>

  <script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxTAugsqiNINTfWLxAVA1h8tVKqmu1s7CpEkteGSunhZF9ywKpJLA9P0kLyzRVapSJydA/exec";
  const employeeSelect = document.getElementById("employee");
  const taskTableBody = document.querySelector("#taskTable tbody");

  employeeSelect.addEventListener("change", loadTasks);

  function loadTasks() {
    const assignee = employeeSelect.value;

    fetch(`${WEB_APP_URL}?view=dashboard&assignee=${encodeURIComponent(assignee)}`)
      .then(res => res.json())
      .then(data => renderTasks(data))
      .catch(() => showToast("⚠️ Failed to load tasks"));
  }

  function renderTasks(tasks) {
    taskTableBody.innerHTML = "";

    if (!Array.isArray(tasks) || tasks.length === 0) {
      taskTableBody.innerHTML = `<tr><td colspan="4">No tasks assigned</td></tr>`;
      return;
    }

    const rows = tasks.map(task => {
      const isCompleted = task.status === "Completed";
      const buttonLabel = isCompleted ? "✅ Task Completed" : "In-Progress";
      const buttonDisabled = isCompleted ? "disabled" : "";

      return `
        <tr>
          <td>${task.description}</td>
          <td>${task.priority}</td>
          <td>${task.status}</td>
          <td>
            <button onclick="markCompleted('${task.id}')" ${buttonDisabled}>
              ${buttonLabel}
            </button>
          </td>
        </tr>
      `;
    }).join("");

    taskTableBody.innerHTML = rows;
  }

  function markCompleted(taskId) {
    const assignee = employeeSelect.value;
    const formData = new FormData();
    formData.append("action", "updateStatus");
    formData.append("taskId", taskId);
    formData.append("assignee", assignee);

    fetch(WEB_APP_URL, {
      method: "POST",
      body: formData
    })
    .then(res => res.text())
    .then(msg => {
      showToast(msg || "✅ Task marked as completed");
      loadTasks();
    })
    .catch(() => showToast("⚠️ Failed to update status"));
  }

  function showToast(message) {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.style.display = "block";
    toast.classList.add("show");

    setTimeout(() => {
      toast.classList.remove("show");
      toast.style.display = "none";
    }, 3000);
  }

  window.onload = () => {
    employeeSelect.value = "";
    loadTasks(); // Optional: auto-load default view
  };
</script>
</body>
</html>
