<script>
  const employeeSelect = document.getElementById("employee");
  const taskTableBody = document.querySelector("#taskTable tbody");
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxTAugsqiNINTfWLxAVA1h8tVKqmu1s7CpEkteGSunhZF9ywKpJLA9P0kLyzRVapSJydA/exec";

  employeeSelect.addEventListener("change", loadTasks);

  function loadTasks() {
    const assignee = employeeSelect.value;
    fetch(`${WEB_APP_URL}?view=dashboard&assignee=${encodeURIComponent(assignee)}`)
      .then(res => res.json())
      .then(renderTasks)
      .catch(() => {
        taskTableBody.innerHTML = `<tr><td colspan="6">⚠️ Failed to load tasks</td></tr>`;
      });
  }

  function renderTasks(tasks) {
    taskTableBody.innerHTML = "";

    if (tasks.length === 0) {
      taskTableBody.innerHTML = `<tr><td colspan="6">No tasks assigned</td></tr>`;
      return;
    }

    tasks.forEach(task => {
      const isCompleted = task.status === "Completed";
      const actionCell = isCompleted
        ? ""
        : `<button onclick="markCompleted('${task.title}')">Mark Completed</button>`;

      const row = `<tr>
        <td>${task.title}</td>
        <td>${task.description}</td>
        <td>${task.priority}</td>
        <td>${task.deadline}</td>
        <td>${task.status}</td>
        <td>${actionCell}</td>
      </tr>`;
      taskTableBody.innerHTML += row;
    });
  }

  function markCompleted(title) {
    const assignee = employeeSelect.value;
    const formData = new FormData();
    formData.append("action", "updateStatus");
    formData.append("title", title);
    formData.append("assignee", assignee);

    fetch(WEB_APP_URL, {
      method: "POST",
      body: formData
    })
    .then(res => res.text())
    .then(msg => {
      showToast(msg);
      loadTasks();
    })
    .catch(() => showToast("⚠️ Failed to update status"));
  }

  function showToast(message) {
    let toast = document.getElementById("toast");
    if (!toast) {
      toast = document.createElement("div");
      toast.id = "toast";
      toast.className = "toast";
      document.body.appendChild(toast);
    }

    toast.textContent = message;
    toast.style.display = "block";
    toast.classList.add("show");

    setTimeout(() => {
      toast.classList.remove("show");
      toast.style.display = "none";
    }, 3000);
  }

  window.onload = () => {
    employeeSelect.value = "Pooja";
    loadTasks();
  };
</script>
